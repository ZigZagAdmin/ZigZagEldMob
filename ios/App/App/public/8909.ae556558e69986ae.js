"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[8909],{8909:(b,_,s)=>{s.r(_),s.d(_,{EditDvirPageModule:()=>tt});var c=s(6895),u=s(4006),g=s(7151),v=s(5050),d=s(5861),p=s(3905),x=s(4128),f=s(4171),h=s(6321),t=s(8256),y=s(849),T=s(9386),Z=s(4382),E=s(7219),M=s(6994),L=s(4465),w=s(7278),J=s(3646),k=s(2187),I=s(4081),O=s(9534),V=s(1585);const B=["sPad"],N=["mechanicSPad"];function U(a,o){1&a&&t._UZ(0,"ion-spinner",33)}const m=function(a){return{"no-display":a}};function A(a,o){if(1&a){const e=t.EpF();t.TgZ(0,"div",30)(1,"img",31),t.NdJ("load",function(){t.CHM(e);const i=t.oxw(2);return t.KtG(i.imageLoaded())}),t.qZA(),t.YNc(2,U,1,0,"ion-spinner",32),t.qZA()}if(2&a){const e=t.oxw(2);t.xp6(1),t.Q6J("ngClass",t.VKq(3,m,e.imageLoading))("src",e.dvir.signatureLink,t.LSH),t.xp6(1),t.Q6J("ngIf",e.imageLoading)}}function Q(a,o){1&a&&(t.TgZ(0,"span"),t._uU(1,"Save"),t.qZA())}function F(a,o){1&a&&t._UZ(0,"ion-spinner",34)}const K=function(a){return{"disable-click":a}};function H(a,o){if(1&a){const e=t.EpF();t.TgZ(0,"form",4)(1,"div",5)(2,"p",6),t._uU(3,"General Info"),t.qZA(),t.TgZ(4,"div",7),t._UZ(5,"app-input",8),t.TgZ(6,"div",9),t._UZ(7,"app-input",8)(8,"app-input",8),t.qZA(),t.TgZ(9,"app-input",10),t.NdJ("valueChange",function(i){t.CHM(e);const r=t.oxw();return t.KtG((null==r.dvir?null:r.dvir.location).description=i)})("validationChange",function(i){t.CHM(e);const r=t.oxw();return t.KtG(r.validation.locationDescription=i)}),t.qZA()(),t.TgZ(10,"div",7),t._UZ(11,"app-input",8)(12,"app-input",8),t.TgZ(13,"app-multiple-select",11),t.NdJ("valueChange",function(i){t.CHM(e);const r=t.oxw();return t.KtG(r.dvir.defectsVehicle=i)})("changeDetection",function(i){t.CHM(e);const r=t.oxw();return t.KtG(r.checkSelectPresent(i))}),t.qZA()(),t.TgZ(14,"p",6),t._uU(15,"Trailer Info"),t.qZA(),t.TgZ(16,"div",7)(17,"app-input",12),t.NdJ("valueChange",function(i){t.CHM(e);const r=t.oxw();return t.KtG(r.dvir.trailers=i)})("validationChange",function(i){t.CHM(e);const r=t.oxw();return t.KtG(r.validation.trailerName=i)}),t.qZA(),t.TgZ(18,"app-multiple-select",11),t.NdJ("valueChange",function(i){t.CHM(e);const r=t.oxw();return t.KtG(r.dvir.defectsTrailers=i)})("changeDetection",function(i){t.CHM(e);const r=t.oxw();return t.KtG(r.checkSelectPresent(i))}),t.qZA()(),t.TgZ(19,"p",6),t._uU(20,"Status"),t.qZA(),t.TgZ(21,"div",7)(22,"div",13)(23,"app-status-radio-button",14),t.NdJ("selectedValue",function(i){t.CHM(e);const r=t.oxw();return t.KtG(r.switchStatus(i))})("valueChange",function(i){t.CHM(e);const r=t.oxw();return t.KtG(r.dvir.status.code=i)}),t.qZA()(),t.TgZ(24,"app-textarea",15),t.NdJ("valueChange",function(i){t.CHM(e);const r=t.oxw();return t.KtG(r.dvir.comments=i)}),t.qZA()(),t.TgZ(25,"p",6),t._uU(26,"Signature"),t.qZA(),t.TgZ(27,"div")(28,"div",16),t._UZ(29,"canvas",17,18),t.YNc(31,A,3,5,"div",19),t.qZA(),t.TgZ(32,"div",20)(33,"div",21),t.NdJ("click",function(){t.CHM(e);const i=t.oxw();return t.KtG(i.clearSignature())}),t._uU(34,"Clear signature"),t.qZA(),t.TgZ(35,"div",21),t.NdJ("click",function(){t.CHM(e);const i=t.oxw();return t.KtG(i.restoreSignature())}),t._uU(36,"Restore signature"),t.qZA()()(),t.TgZ(37,"p",22),t._uU(38,"Mechanic Signature"),t.qZA(),t.TgZ(39,"div",23),t._UZ(40,"app-input",8)(41,"app-input",8),t.qZA(),t.TgZ(42,"div",24)(43,"div",16),t._UZ(44,"canvas",25,26),t.qZA(),t.TgZ(46,"div",20)(47,"div",21),t.NdJ("click",function(){t.CHM(e);const i=t.oxw();return t.KtG(i.clearMechanicSignature())}),t._uU(48,"Clear signature"),t.qZA()()(),t.TgZ(49,"button",27),t.NdJ("click",function(){t.CHM(e);const i=t.oxw();return t.KtG(i.onSubmit())}),t.YNc(50,Q,2,0,"span",28),t.YNc(51,F,1,0,"ion-spinner",29),t.qZA()()()}if(2&a){const e=t.oxw();t.xp6(5),t.Q6J("label","Company")("fill",!0)("type","text")("disabled",!0)("value",null==e.company?null:e.company.name)("noValidation",!0),t.xp6(2),t.Q6J("label","Time")("fill",!0)("type","text")("disabled",!0)("value",e.getHour(null==e.dvir?null:e.dvir.createDate))("noValidation",!0),t.xp6(1),t.Q6J("label","none")("fill",!0)("type","text")("disabled",!0)("value",e.getTime(null==e.dvir?null:e.dvir.createDate))("noValidation",!0),t.xp6(1),t.Q6J("label","Location")("fill",!0)("type","text")("disabled",e.locationDisable)("value",null==e.dvir?null:e.dvir.location.description)("validation",e.validation.locationDescription),t.xp6(2),t.Q6J("label","Vehicle Name")("fill",!0)("type","text")("disabled",e.vehicleUnitDisable)("value",null==e.dvir?null:e.dvir.vehicle.vehicleUnit)("noValidation",!0),t.xp6(1),t.Q6J("label","Odometer")("fill",!0)("type","text")("disabled",!0)("value",null==e.dvir?null:e.dvir.odometer.toString())("noValidation",!0),t.xp6(1),t.Q6J("label","Vehicle Defects (Optional)")("value",e.dvir.defectsVehicle)("options",e.defectsVehicle),t.xp6(4),t.Q6J("label","Trailer Name")("fill",!0)("type","text")("value",e.dvir.trailers)("validation",e.validation.trailerName)("noValidation",!e.dvir.defectsTrailers.length),t.xp6(1),t.Q6J("label","Trailer Defects (Optional)")("value",e.dvir.defectsTrailers)("options",e.defectsTrailers),t.xp6(5),t.Q6J("half",!1)("value",e.dvir.status.code)("disableOption",e.optionDisable),t.xp6(1),t.Q6J("label","Comments")("fill",!0)("type","text")("value",e.dvir.comments)("noValidation",!0),t.xp6(5),t.Q6J("ngClass",t.VKq(76,m,e.signatureFound)),t.xp6(2),t.Q6J("ngIf",e.signatureFound),t.xp6(6),t.Q6J("ngClass",t.VKq(78,m,"DC"!==e.dvir.status.code)),t.xp6(2),t.Q6J("ngClass",t.VKq(80,m,"DC"!==e.dvir.status.code)),t.xp6(1),t.Q6J("label","Signature Date")("fill",!0)("type","text")("disabled",!0)("value",e.getHour(e.today.getTime()))("noValidation",!0),t.xp6(1),t.Q6J("label","none")("fill",!0)("type","text")("disabled",!0)("value",e.getTime(e.today.getTime()))("noValidation",!0),t.xp6(1),t.Q6J("ngClass",t.VKq(82,m,"DC"!==e.dvir.status.code)),t.xp6(7),t.Q6J("ngClass",t.VKq(84,K,e.loading)),t.xp6(1),t.Q6J("ngIf",!e.loading),t.xp6(1),t.Q6J("ngIf",e.loading)}}function G(a,o){1&a&&(t.TgZ(0,"div",35),t._UZ(1,"ion-spinner",36),t.TgZ(2,"div"),t._uU(3,"LOADING"),t.qZA()())}const R=[{path:"",component:(()=>{class a{constructor(e,n,i,r,l,C,S,P,D,et){this.navCtrl=e,this.storage=n,this.dashboardService=i,this.databaseService=r,this.internetService=l,this.activatedRoute=C,this.router=S,this.shareService=P,this.toastService=D,this.utilityService=et,this.defectsVehicle=h.mK,this.defectsTrailers=h.mK,this.DvirStatuses=[{StatusCode:"VCS",StatusName:"Vehicle Condition Satisfactory"},{StatusCode:"D",StatusName:"Has Defects"},{StatusCode:"DC",StatusName:"Defects Corrected"},{StatusCode:"DNNBC",StatusName:"Defects Need Not Be Corrected"}],this.signaturePadOptions={minWidth:2,maxWidth:3,backgroundColor:"#FFFFFF",penColor:"black"},this.dvirs=[],this.bReady=!1,this.pickedVehicle="",this.vehicleId="",this.driverId="",this.networkStatus=!1,this.validation={trailerName:!1,locationDescription:!1},this.locationDisable=!1,this.vehicleUnitDisable=!1,this.lastStatus="",this.optionDisable=!0,this.loading=!1,this.pageLoading=!1,this.signatureFound=!1,this.imageLoading=!1,this.today=new Date,this.timeZone=""}ngOnInit(){this.pageLoading=!0,this.imageLoading=!0;let e=(0,p.z)(this.activatedRoute.queryParams),n=(0,p.z)(this.databaseService.getCompany()),i=(0,p.z)(this.databaseService.getDvirs()),r=this.storage.get("timeZone");(0,x.D)([n,i,e,r]).subscribe(([l,C,S,P])=>{this.dvirId=S.dvirId,this.company=l,this.dvirs=C,this.timeZone=P,this.dvir=this.dvirs.find(D=>D.dvirId===this.dvirId),this.dvir.signatureBase64="",this.dvir.mechanicSignatureBase64="",this.dvir.mechanicSignatureLink="",this.locationDisable=!!this.dvir.location.description,this.vehicleUnitDisable=!!this.dvir.vehicle.vehicleUnit,this.pageLoading=!1},l=>console.log(l)),this.networkSub=this.internetService.internetStatus$.subscribe(l=>this.networkStatus=l)}ionViewDidEnter(){this.initSignaturePad(),this.initMechanicalSignaturePad()}ngOnDestroy(){this.networkSub.unsubscribe()}switchStatus(e){0!==e.length&&e!==this.lastStatus&&(this.lastStatus=e,this.dvir.status.code=e,this.dvir.status.name=h.bO.find(n=>n.code===e).name),this.dvir.mechanicSignatureId="00000000-0000-0000-0000-000000000000",this.dvir.mechanicSignatureBase64="",this.clearMechanicSignature()}imageLoaded(){this.imageLoading=!1}checkSelectPresent(e){this.switchStatus(""===this.dvir.defectsTrailers&&""===this.dvir.defectsVehicle?"VCS":"D")}navigateBack(){this.router.navigate(["/unitab/dvir"])}onSubmit(){var e=this;return(0,d.Z)(function*(){if(e.shareService.changeMessage("reset"),0===e.dvir.defectsTrailers.length&&(e.validation.trailerName=!0),e.shareService.changeMessage(e.utilityService.generateString(5)),e.utilityService.validateForm(e.validation)){if("D"===e.dvir.status.code&&0===e.dvir.defectsTrailers.length&&0===e.dvir.defectsVehicle.length)return void e.toastService.showToast('You cannot select "Has Defects" without selecting any defect!');if(0===e.dvir.signatureBase64.length&&0===e.dvir.signatureLink.length)return void e.toastService.showToast("Please sign the form before saving!");if("DC"===e.dvir.status.code&&(e.dvir.mechanicSignatureId=e.utilityService.uuidv4()),"DC"===e.dvir.status.code&&0===e.dvir.mechanicSignatureBase64.length&&0===e.dvir.mechanicSignatureLink.length)return void e.toastService.showToast("Please complete the mechanic signature!");!0===e.networkStatus?(e.loading=!0,e.dashboardService.updateDVIR(e.dvir).toPromise().then(function(){var n=(0,d.Z)(function*(i){i.signatureLink&&(e.dvir.signatureLink=i.signatureLink),i.mechanicSignatureLink&&(e.dvir.mechanicSignatureLink=i.mechanicSignatureLink),yield e.updateDvirs(e.dvir,!0).then(()=>{console.log("DVIRs got updated on the server: ",i),e.loading=!1,e.navCtrl.navigateBack("/unitab/dvir")})});return function(i){return n.apply(this,arguments)}}()).catch(function(){var n=(0,d.Z)(function*(i){yield e.updateDvirs(e.dvir,!1).then(()=>{e.loading=!1,e.navCtrl.navigateBack("/unitab/dvir"),console.warn("Server Error: ",i),console.warn("Pushed dvirs in offline mode")})});return function(i){return n.apply(this,arguments)}}())):yield e.updateDvirs(e.dvir,!1).then(()=>{e.loading=!1,console.warn("Pushed dvirs in offline mode"),e.navCtrl.navigateBack("/unitab/dvir")})}})()}updateDvirs(e,n){var i=this;return(0,d.Z)(function*(){e.sent=n;let r=i.dvirs.findIndex(l=>l.dvirId===e.dvirId);-1!==r&&(i.dvirs[r]=e),yield i.storage.set("dvirs",i.dvirs),i.navCtrl.navigateBack("/unitab/dvir")})()}initSignaturePad(){const e=this.signaturePadElement.nativeElement;e&&(this.signaturePad=new f.Z(e,this.signaturePadOptions),e.addEventListener("touchend",()=>{this.updateSignatureField()}),this.dvir&&this.dvir.signatureBase64&&this.renderSignature("data:image/png;base64,"+this.dvir.signatureBase64)),this.dvir.signatureLink&&0!==this.dvir.signatureLink.length&&(this.signatureFound=!0)}initMechanicalSignaturePad(){const e=this.mechanicSignaturePadElement.nativeElement;e&&(this.mechanicSignaturePad=new f.Z(e,this.signaturePadOptions),e.addEventListener("touchend",()=>{this.updateMechanicSignatureField()}),this.dvir&&this.dvir.mechanicSignatureBase64&&this.renderMechanicSignature("data:image/png;base64,"+this.dvir.mechanicSignatureBase64))}renderSignature(e){const n=this.signaturePadElement.nativeElement;if(n){const i=n.getContext("2d"),r=new Image;r.onload=()=>{null==i||i.drawImage(r,0,0)},r.src=e}}renderMechanicSignature(e){const n=this.mechanicSignaturePadElement.nativeElement;if(n){const i=n.getContext("2d"),r=new Image;r.onload=()=>{null==i||i.drawImage(r,0,0)},r.src=e}}clearSignature(){this.signatureFound&&(this.signatureFound=!1,this.dvir.signatureLink=""),this.signaturePad&&(this.signaturePad.clear(),this.dvir.signatureBase64="")}restoreSignature(){var e=this;return(0,d.Z)(function*(){const n=e.dvirs.find(i=>""!==i.signatureId&&"00000000-0000-0000-0000-000000000000"!==i.signatureId&&""!==i.signatureLink);n?(e.dvir.signatureBase64="",e.dvir.signatureLink=n.signatureLink,e.dvir.signatureId=n.signatureId,e.signatureFound=!0):(e.signatureFound=!1,e.toastService.showToast("No signature found on this current dvir."))})()}clearMechanicSignature(){this.mechanicSignaturePad&&(this.mechanicSignaturePad.clear(),this.dvir.mechanicSignatureBase64="")}updateSignatureField(){if(this.signaturePad&&!this.signaturePad.isEmpty()){const e=this.signaturePad.toDataURL().slice(22);this.dvir.signatureBase64=e}else this.dvir.signatureBase64=""}updateMechanicSignatureField(){if(this.mechanicSignaturePad&&!this.mechanicSignaturePad.isEmpty()){const e=this.mechanicSignaturePad.toDataURL();this.dvir.mechanicSignatureBase64=e,this.dvir.repairDate=this.today.getTime(),this.dvir.repairTimeZone=this.timeZone}else this.dvir.mechanicSignatureBase64=""}getCurrentDate(){return(new Date).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}getCurrentTime(){return(new Date).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})}goBack(){this.navCtrl.navigateBack("/unitab/dvir"),this.shareService.destroyMessage()}getHour(e){return(0,c.p6)(e,"LLL d'th', yyyy","en_US")}getTime(e){return(0,c.p6)(e,"hh:mm a","en_US")}}return a.\u0275fac=function(e){return new(e||a)(t.Y36(g.SH),t.Y36(y.K),t.Y36(T.s),t.Y36(Z.k),t.Y36(E.W),t.Y36(v.gz),t.Y36(v.F0),t.Y36(M.t),t.Y36(L.k),t.Y36(w.t))},a.\u0275cmp=t.Xpm({type:a,selectors:[["app-edit-dvir"]],viewQuery:function(e,n){if(1&e&&(t.Gf(B,5),t.Gf(N,5)),2&e){let i;t.iGM(i=t.CRH())&&(n.signaturePadElement=i.first),t.iGM(i=t.CRH())&&(n.mechanicSignaturePadElement=i.first)}},decls:4,vars:5,consts:[[3,"forceOverscroll"],[3,"title","backButton","backButtonCallback"],["class","padding-g","style","padding-top: 10px",4,"ngIf"],["class","spinner-container",4,"ngIf"],[1,"padding-g",2,"padding-top","10px"],[1,"edit-form"],[1,"subtitle-lg"],[1,"edit-dvir-block"],[3,"label","fill","type","disabled","value","noValidation"],[1,"two-inputs"],[3,"label","fill","type","disabled","value","validation","valueChange","validationChange"],[3,"label","value","options","valueChange","changeDetection"],[3,"label","fill","type","value","validation","noValidation","valueChange","validationChange"],[1,"input-block-2"],[3,"half","value","disableOption","selectedValue","valueChange"],[3,"label","fill","type","value","noValidation","valueChange"],[1,"canvas-container"],["height","200",2,"touch-action","none","user-select","none",3,"ngClass"],["sPad",""],["class","image-container",4,"ngIf"],[1,"signature-buttons"],[1,"signature-button",3,"click"],[1,"subtitle-lg",3,"ngClass"],[1,"two-inputs",3,"ngClass"],[3,"ngClass"],["height","200",2,"touch-action","none","user-select","none"],["mechanicSPad",""],[1,"btn","primary-btn",3,"ngClass","click"],[4,"ngIf"],["name","circular","color","light",4,"ngIf"],[1,"image-container"],[3,"ngClass","src","load"],["name","dots","color","dark",4,"ngIf"],["name","dots","color","dark"],["name","circular","color","light"],[1,"spinner-container"],["color","dark"]],template:function(e,n){1&e&&(t.TgZ(0,"ion-content",0)(1,"app-header",1),t.NdJ("backButtonCallback",function(){return n.goBack()}),t.qZA(),t.YNc(2,H,52,86,"form",2),t.YNc(3,G,4,0,"div",3),t.qZA()),2&e&&(t.Q6J("forceOverscroll",!1),t.xp6(1),t.Q6J("title","Edit Dvir")("backButton",!0),t.xp6(1),t.Q6J("ngIf",!n.pageLoading),t.xp6(1),t.Q6J("ngIf",n.pageLoading))},dependencies:[c.mk,c.O5,u._Y,u.JL,u.F,g.W2,g.PQ,J.G,k.a,I.R,O.D,V.M],styles:[".input-block-2[_ngcontent-%COMP%]   textarea.input-2[_ngcontent-%COMP%]{height:89px;resize:none}.text-success[_ngcontent-%COMP%]{flex-grow:1;color:var(--success-500);font-size:16px;font-weight:500}.text-error[_ngcontent-%COMP%]{flex-grow:1;color:var(--error-500);font-size:16px;font-weight:600}.btn[_ngcontent-%COMP%]{width:100%;height:50px;border-radius:30px}.two-inputs[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;gap:10px}.signature-container[_ngcontent-%COMP%]{width:100%;background-color:var(--gray-100);border-radius:10px;padding:15px;display:flex;justify-content:center;align-items:center}.signature-container[_ngcontent-%COMP%]   canvas[_ngcontent-%COMP%]{width:100%;border-radius:10px}.spinner-container[_ngcontent-%COMP%]{width:100%;height:calc(100% - 114px);display:flex;justify-content:center;align-items:center;flex-direction:column;font-size:14px;gap:5px}.spinner-container[_ngcontent-%COMP%]   ion-spinner[_ngcontent-%COMP%]{width:30px;height:30px}.canvas-container[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;width:100%;height:230px;max-width:500px;background-color:var(--gray-100);border-radius:10px;padding:15px}.canvas-container[_ngcontent-%COMP%]   canvas[_ngcontent-%COMP%]{width:100%;height:100%;border-radius:10px}.image-container[_ngcontent-%COMP%]{width:100%;height:100%;background-color:#fff;border-radius:10px;display:flex;justify-content:center;align-items:center}.image-container[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{border-radius:10px}.no-display[_ngcontent-%COMP%]{display:none;width:0;height:0;border:none}.signature-buttons[_ngcontent-%COMP%]{display:flex;gap:30px;margin-top:10px}.signature-button[_ngcontent-%COMP%]{font-size:15px;font-weight:500;color:var(--gray-500)}"]}),a})()}];let Y=(()=>{class a{}return a.\u0275fac=function(e){return new(e||a)},a.\u0275mod=t.oAB({type:a}),a.\u0275inj=t.cJS({imports:[v.Bz.forChild(R),v.Bz]}),a})();var z=s(4546),j=s(4166),W=s(8546),$=s(4877),X=s(7484),q=s(6330);let tt=(()=>{class a{}return a.\u0275fac=function(e){return new(e||a)},a.\u0275mod=t.oAB({type:a}),a.\u0275inj=t.cJS({providers:[g.X1],imports:[c.ez,u.u5,g.Pc,Y,u.UX,z.y,j.v,W.w,$.r,X.T,q._]}),a})()},3905:(b,_,s)=>{s.d(_,{z:()=>g});var c=s(6805),u=s(930);function g(v,d){const p="object"==typeof d;return new Promise((x,f)=>{const h=new u.Hp({next:t=>{x(t),h.unsubscribe()},error:f,complete:()=>{p?x(d.defaultValue):f(new c.K)}});v.subscribe(h)})}}}]);