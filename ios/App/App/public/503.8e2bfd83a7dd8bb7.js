"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[503],{503:(ae,C,n)=>{n.r(C),n.d(C,{InsertDvirPageModule:()=>ie});var d=n(6895),u=n(4006),c=n(7151),P=n(5050),l=n(5861),T=n(3905),D=n(4128),S=n(4171),g=n(6321),b=n(5670),Z=n(7423),e=n(8256),L=n(4382),_=n(849),J=n(9386),M=n(9393),V=n(7278),U=n(6994),x=n(4465),O=n(7940),k=n(546),A=n(3646),N=n(9534),F=n(2187),B=n(4081),Q=n(1585),Y=n(7236);function R(s,o){1&s&&e._UZ(0,"ion-spinner",25)}const I=function(s){return{"no-display":s}};function z(s,o){if(1&s){const t=e.EpF();e.TgZ(0,"div",22)(1,"img",23),e.NdJ("load",function(){e.CHM(t);const a=e.oxw();return e.KtG(a.imageLoaded())}),e.qZA(),e.YNc(2,R,1,0,"ion-spinner",24),e.qZA()}if(2&s){const t=e.oxw();e.xp6(1),e.Q6J("ngClass",e.VKq(3,I,t.imageLoading))("src",t.dvir.signatureLink,e.LSH),e.xp6(1),e.Q6J("ngIf",t.imageLoading)}}function H(s,o){1&s&&(e.TgZ(0,"span"),e._uU(1,"Save"),e.qZA())}function j(s,o){1&s&&e._UZ(0,"ion-spinner",26)}const w=function(s){return{"disable-click":s}},K=[{path:"",component:(()=>{class s{constructor(t,i,a,r,v,p,h,f,m,y){this.databaseService=t,this.storage=i,this.dashboardService=a,this.internetService=r,this.navCtrl=v,this.utilityService=p,this.shareService=h,this.toastService=f,this.locationService=m,this.interService=y,this.defectsVehicle=g.mK,this.defectsTrailers=g.Jk,this.signaturePadOptions={minWidth:2,maxWidth:3,backgroundColor:"#FFFFFF",penColor:"black"},this.DvirId="",this.dvirs=[],this.bReady=!1,this.vehicleUnit="",this.vehicleId="",this.driverId="",this.statusIcon="checkmark-circle-outline",this.imageLoading=!1,this.dvir={dvirId:this.utilityService.uuidv4(),driver:{driverId:""},vehicle:{vehicleUnit:"",vehicleId:""},odometer:0,trailers:"",defectsVehicle:"",defectsTrailers:"",remarks:"",status:{code:"",name:""},location:{description:"",latitude:0,longitude:0},createDate:new Date((0,d.p6)(new Date,"yyyy-MM-ddTHH:mm:ss","en-US")).getTime(),createTimeZone:"",repairDate:0,repairTimeZone:"",signatureId:this.utilityService.uuidv4(),signatureBase64:"",signatureLink:""},this.validation={trailerName:!1,locationDescription:!1},this.locationDisable=!1,this.locationLoading=!1,this.vehicleUnitDisable=!1,this.lastStatus="",this.optionDisable=!0,this.loading=!1,this.signatureFound=!1}ngOnInit(){var t=this;return(0,l.Z)(function*(){t.dvir.status.name="Vehicle Condition Satisfactory",t.dvir.status.code="VCS",t.dvir.defectsVehicle="",t.dvir.defectsTrailers="";let i=(0,T.z)(t.databaseService.getCompany()),a=(0,T.z)(t.databaseService.getDvirs()),r=t.storage.get("vehicleUnit"),v=t.storage.get("vehicleId"),p=t.storage.get("driverId");(0,D.D)([i,a,r,v,p]).subscribe(([h,f,m,y,ne])=>{t.company=h,t.dvirs=f,t.vehicleUnit=m,t.vehicleUnitDisable=!!t.vehicleUnit,t.vehicleId=y,t.driverId=ne}),yield t.getLocalCurrentLocation()})()}getLocalCurrentLocation(){var t=this;return(0,l.Z)(function*(){t.locationLoading=!0;let i=yield t.storage.get("locationStatus");"web"!==Z.dV.getPlatform()&&(i||t.toastService.showToast("Problems fetching location! Check the location service!","danger",2500)),yield t.locationService.getCurrentLocation().then(a=>{t.dvir.location=a,t.locationLoading=!1,t.locationDisable="AUTOMATIC"===t.dvir.location.locationType})})()}ngOnDestroy(){this.shareService.destroyMessage()}ngAfterViewInit(){this.initSignaturePad()}checkSelectPresent(t){this.switchStatus(""===this.dvir.defectsTrailers&&""===this.dvir.defectsVehicle?"VCS":"D")}switchStatus(t){0!==t.length&&t!==this.lastStatus&&(this.lastStatus=t,this.dvir.status.code=t,this.dvir.status.name=g.bO.find(i=>i.code===t).name)}initSignaturePad(){const t=document.querySelector("canvas");t&&(this.signaturePad=new S.Z(t,this.signaturePadOptions),t.addEventListener("touchend",()=>{this.updateSignatureField()}))}updateSignatureField(){if(this.signaturePad&&!this.signaturePad.isEmpty()){const t=this.signaturePad.toDataURL().slice(22);this.dvir.signatureBase64=t}else this.dvir.signatureBase64=""}restoreSignature(){var t=this;return(0,l.Z)(function*(){const i=t.dvirs.find(a=>""!==a.signatureId&&"00000000-0000-0000-0000-000000000000"!==a.signatureId&&""!==a.signatureLink);i?(t.dvir.signatureBase64="",t.dvir.signatureLink=i.signatureLink,t.dvir.signatureId=i.signatureId,t.signatureFound=!0):(t.signatureFound=!1,t.toastService.showToast("No signature found on other daily logs."))})()}clearSignature(){this.signatureFound&&(this.signatureFound=!1,this.dvir.signatureLink=""),this.signaturePad&&(this.signaturePad.clear(),this.dvir.signatureBase64="")}imageLoaded(){this.imageLoading=!1}onSubmit(){var t=this;return(0,l.Z)(function*(){let i=yield b.Z.getStatus();if(t.shareService.changeMessage("reset"),0===t.dvir.defectsTrailers.length&&(t.validation.trailerName=!0),t.shareService.changeMessage(t.utilityService.generateString(5)),t.utilityService.validateForm(t.validation)){if(0===t.dvir.signatureBase64.length&&0===t.dvir.signatureLink.length)return void t.toastService.showToast("Please sign the form before saving!");t.dvir.vehicle.vehicleUnit=t.vehicleUnit,t.dvir.vehicle.vehicleId=t.vehicleId,t.dvir.driver.driverId=t.driverId,t.loading=!0,!0===i.connected?t.dashboardService.updateDVIR(t.dvir).toPromise().then(function(){var a=(0,l.Z)(function*(r){r.signatureLink&&(t.dvir.signatureLink=r.signatureLink),yield t.updateDvirs(t.dvir,!0).then(()=>{console.log("DVIRs got updated on the server: ",r),t.loading=!1,setTimeout(()=>t.goBack(),0)})});return function(r){return a.apply(this,arguments)}}()).catch(function(){var a=(0,l.Z)(function*(r){yield t.updateDvirs(t.dvir,!1).then(()=>{t.loading=!1,setTimeout(()=>{t.goBack()},0),console.warn("Server Error: ",r),console.warn("Pushed dvirs in offline mode")})});return function(r){return a.apply(this,arguments)}}()):yield t.updateDvirs(t.dvir,!1).then(()=>{t.loading=!1,setTimeout(()=>t.goBack(),0),console.warn("Pushed dvirs in offline mode")})}})()}updateDvirs(t,i){var a=this;return(0,l.Z)(function*(){t.sent=i,a.dvirs.unshift(t),yield a.storage.set("dvirs",a.dvirs)})()}ionViewWillLeave(){this.databaseSubscription&&this.databaseSubscription.unsubscribe()}goBack(){this.interService.changeMessage({topic:"dvir"}),this.navCtrl.navigateBack("/unitab/dvir"),this.shareService.destroyMessage()}getHour(t){return(0,d.p6)(t,"LLL d'th', yyyy","en_US")}getTime(t){return(0,d.p6)(t,"hh:mm a","en_US")}}return s.\u0275fac=function(t){return new(t||s)(e.Y36(L.k),e.Y36(_.K),e.Y36(J.s),e.Y36(M.W),e.Y36(c.SH),e.Y36(V.t),e.Y36(U.t),e.Y36(x.k),e.Y36(O.a),e.Y36(k.o))},s.\u0275cmp=e.Xpm({type:s,selectors:[["app-insert-dvir"]],decls:44,vars:68,consts:[[3,"title","backButton","backButtonCallback"],[1,"padding-g",2,"padding-top","10px"],[1,"edit-form"],[1,"subtitle-lg"],[1,"edit-dvir-block"],[3,"label","fill","type","disabled","value","noValidation"],[1,"two-inputs"],[3,"label","fill","type","disabled","loading","value","validation","valueChange","gpsCallback","validationChange"],[3,"label","value","options","valueChange","changeDetection"],[3,"label","fill","type","value","validation","noValidation","valueChange","validationChange"],[1,"input-block-2"],[3,"half","value","disableOption","selectedValue","valueChange"],[3,"label","fill","type","value","noValidation","valueChange"],[1,"canvas-container"],["height","200",2,"touch-action","none","user-select","none",3,"ngClass"],["sPad",""],["class","image-container",4,"ngIf"],[1,"signature-buttons"],[1,"signature-button",3,"click"],[1,"btn","primary-btn",3,"ngClass","click"],[4,"ngIf"],["name","circular","color","light",4,"ngIf"],[1,"image-container"],[3,"ngClass","src","load"],["name","dots","color","dark",4,"ngIf"],["name","dots","color","dark"],["name","circular","color","light"]],template:function(t,i){1&t&&(e.TgZ(0,"ion-content")(1,"app-header",0),e.NdJ("backButtonCallback",function(){return i.goBack()}),e.qZA(),e.TgZ(2,"form",1)(3,"div",2)(4,"p",3),e._uU(5,"General Info"),e.qZA(),e.TgZ(6,"div",4),e._UZ(7,"app-input",5),e.TgZ(8,"div",6),e._UZ(9,"app-input",5)(10,"app-input",5),e.qZA(),e.TgZ(11,"app-location-input",7),e.NdJ("valueChange",function(r){return i.dvir.location.description=r})("gpsCallback",function(){return i.getLocalCurrentLocation()})("validationChange",function(r){return i.validation.locationDescription=r}),e.qZA()(),e.TgZ(12,"p",3),e._uU(13,"Vehicle Info"),e.qZA(),e.TgZ(14,"div",4),e._UZ(15,"app-input",5)(16,"app-input",5),e.TgZ(17,"app-multiple-select",8),e.NdJ("valueChange",function(r){return i.dvir.defectsVehicle=r})("changeDetection",function(r){return i.checkSelectPresent(r)}),e.qZA()(),e.TgZ(18,"p",3),e._uU(19,"Trailer Info"),e.qZA(),e.TgZ(20,"div",4)(21,"app-input",9),e.NdJ("valueChange",function(r){return i.dvir.trailers=r})("validationChange",function(r){return i.validation.trailerName=r}),e.qZA(),e.TgZ(22,"app-multiple-select",8),e.NdJ("valueChange",function(r){return i.dvir.defectsTrailers=r})("changeDetection",function(r){return i.checkSelectPresent(r)}),e.qZA()(),e.TgZ(23,"p",3),e._uU(24,"Status"),e.qZA(),e.TgZ(25,"div",4)(26,"div",10)(27,"app-status-radio-button",11),e.NdJ("selectedValue",function(r){return i.switchStatus(r)})("valueChange",function(r){return i.dvir.status.code=r}),e.qZA()(),e.TgZ(28,"app-textarea",12),e.NdJ("valueChange",function(r){return i.dvir.comments=r}),e.qZA()(),e.TgZ(29,"p",3),e._uU(30,"Signature"),e.qZA(),e.TgZ(31,"div")(32,"div",13),e._UZ(33,"canvas",14,15),e.YNc(35,z,3,5,"div",16),e.qZA(),e.TgZ(36,"div",17)(37,"div",18),e.NdJ("click",function(){return i.clearSignature()}),e._uU(38,"Clear signature"),e.qZA(),e.TgZ(39,"div",18),e.NdJ("click",function(){return i.restoreSignature()}),e._uU(40,"Restore signature"),e.qZA()()(),e.TgZ(41,"button",19),e.NdJ("click",function(){return i.onSubmit()}),e.YNc(42,H,2,0,"span",20),e.YNc(43,j,1,0,"ion-spinner",21),e.qZA()()()()),2&t&&(e.xp6(1),e.Q6J("title","Insert Dvir")("backButton",!0),e.xp6(6),e.Q6J("label","Company")("fill",!0)("type","text")("disabled",!0)("value",null==i.company?null:i.company.name)("noValidation",!0),e.xp6(2),e.Q6J("label","Time")("fill",!0)("type","text")("disabled",!0)("value",i.getHour(i.dvir.createDate))("noValidation",!0),e.xp6(1),e.Q6J("label","none")("fill",!0)("type","text")("disabled",!0)("value",i.getTime(i.dvir.createDate))("noValidation",!0),e.xp6(1),e.Q6J("label","Location")("fill",!0)("type","text")("disabled",i.locationDisable)("loading",i.locationLoading)("value",i.dvir.location.description)("validation",i.validation.locationDescription),e.xp6(4),e.Q6J("label","Vehicle Name")("fill",!0)("type","text")("disabled",i.vehicleUnitDisable)("value",i.vehicleUnit)("noValidation",!0),e.xp6(1),e.Q6J("label","Odometer")("fill",!0)("type","text")("disabled",!0)("value",i.dvir.odometer.toString())("noValidation",!0),e.xp6(1),e.Q6J("label","Vehicle Defects (Optional)")("value",i.dvir.defectsVehicle)("options",i.defectsVehicle),e.xp6(4),e.Q6J("label","Trailer Name")("fill",!0)("type","text")("value",i.dvir.trailers)("validation",i.validation.trailerName)("noValidation",!i.dvir.defectsTrailers.length),e.xp6(1),e.Q6J("label","Trailer Defects (Optional)")("value",i.dvir.defectsTrailers)("options",i.defectsTrailers),e.xp6(5),e.Q6J("half",!0)("value",i.dvir.status.code)("disableOption",!0),e.xp6(1),e.Q6J("label","Comments")("fill",!0)("type","text")("value",i.dvir.comments)("noValidation",!0),e.xp6(5),e.Q6J("ngClass",e.VKq(64,I,i.signatureFound)),e.xp6(2),e.Q6J("ngIf",i.signatureFound),e.xp6(6),e.Q6J("ngClass",e.VKq(66,w,i.loading)),e.xp6(1),e.Q6J("ngIf",!i.loading),e.xp6(1),e.Q6J("ngIf",i.loading))},dependencies:[d.mk,d.O5,u._Y,u.JL,u.F,c.W2,c.PQ,A.G,N.D,F.a,B.R,Q.M,Y.L],styles:[".input-block-2[_ngcontent-%COMP%]   textarea.input-2[_ngcontent-%COMP%]{height:89px;resize:none}.text-success[_ngcontent-%COMP%]{flex-grow:1;color:var(--success-500);font-size:16px;font-weight:500}.text-error[_ngcontent-%COMP%]{flex-grow:1;color:var(--error-500);font-size:16px;font-weight:600}.btn[_ngcontent-%COMP%]{width:100%;height:50px;border-radius:30px;margin-top:5px}.two-inputs[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;gap:10px}.signature-container[_ngcontent-%COMP%]{width:100%;background-color:var(--gray-100);border-radius:10px;padding:15px;display:flex;justify-content:center;align-items:center}.signature-container[_ngcontent-%COMP%]   canvas[_ngcontent-%COMP%]{width:100%;border-radius:10px}.signature-buttons[_ngcontent-%COMP%]{display:flex;gap:30px;margin-top:10px}.signature-button[_ngcontent-%COMP%]{font-size:15px;font-weight:500;color:var(--gray-500)}.canvas-container[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;width:100%;height:230px;max-width:500px;background-color:var(--gray-100);border-radius:10px;padding:15px}.canvas-container[_ngcontent-%COMP%]   canvas[_ngcontent-%COMP%]{width:100%;height:100%;border-radius:10px}.image-container[_ngcontent-%COMP%]{width:100%;background-color:#fff;border-radius:10px;display:flex;justify-content:center;align-items:center}.image-container[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{border-radius:10px}.no-display[_ngcontent-%COMP%]{display:none;width:0;height:0;border:none}"]}),s})()}];let E=(()=>{class s{}return s.\u0275fac=function(t){return new(t||s)},s.\u0275mod=e.oAB({type:s}),s.\u0275inj=e.cJS({imports:[P.Bz.forChild(K),P.Bz]}),s})();var W=n(4546),$=n(7484),G=n(4166),X=n(8546),q=n(4877),ee=n(6330),te=n(8134);let ie=(()=>{class s{}return s.\u0275fac=function(t){return new(t||s)},s.\u0275mod=e.oAB({type:s}),s.\u0275inj=e.cJS({imports:[d.ez,u.u5,u.UX,c.Pc,E,W.y,$.T,G.v,X.w,q.r,ee._,te.y]}),s})()}}]);